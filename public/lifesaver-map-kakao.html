<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>인명구조함 지도 (클러스터링)</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    .cluster-label {
      background-color: rgba(255, 100, 100, 0.8);
      border-radius: 50%;
      color: white;
      text-align: center;
      font-size: 14px;
      line-height: 40px;
      width: 40px;
      height: 40px;
      border: 2px solid white;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
    }
    #buttons {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }
    button {
      margin: 2px;
      padding: 6px 10px;
      font-size: 14px;
    }
  </style>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=d02572eca2dd38bbbbb6692254d51bb7&libraries=services"></script>
</head>
<body>
  <div id="buttons">
    <button onclick="moveToCurrentLocation()">내 위치로 이동</button>
    <button onclick="toggleMapType()">항공뷰</button>
  </div>
  <div id="map"></div>

  <script>
    const apiUrl = "https://kcg-1099287947809.us-central1.run.app/lifesavers_filtered";
    let map, mapType = 'ROADMAP';
    let markers = [], clusterOverlays = [];

    function initMap() {
      map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 5
      });

      kakao.maps.event.addListener(map, 'idle', fetchAndRenderMarkers);
    }

    function clearOverlays() {
      markers.forEach(m => m.setMap(null));
      clusterOverlays.forEach(o => o.setMap(null));
      markers = [];
      clusterOverlays = [];
    }

    function fetchAndRenderMarkers() {
      const bounds = map.getBounds();
      const zoom = map.getLevel();
      const params = new URLSearchParams({
        left: bounds.getSouthWest().getLng(),
        bottom: bounds.getSouthWest().getLat(),
        right: bounds.getNorthEast().getLng(),
        top: bounds.getNorthEast().getLat(),
        zoom: zoom
      });

      fetch(`${apiUrl}?${params}`)
        .then(res => res.json())
        .then(data => {
          clearOverlays();

          if (data.lifesavers.length === 0 && data.count > 0) {
            // 줌이 작을 때 클러스터 숫자만 표시
            const center = map.getCenter();
            const overlay = new kakao.maps.CustomOverlay({
              content: `<div class="cluster-label">${data.count}</div>`,
              position: center,
              yAnchor: 1
            });
            overlay.setMap(map);
            clusterOverlays.push(overlay);
          } else {
            data.lifesavers.forEach(item => {
              const marker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(item.lat, item.lng),
                title: item.name || "구조함"
              });
              marker.setMap(map);
              markers.push(marker);
            });
          }
        });
    }

    function moveToCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const loc = new kakao.maps.LatLng(lat, lng);
          map.setCenter(loc);
        });
      } else {
        alert("위치 정보를 지원하지 않는 브라우저입니다.");
      }
    }

    function toggleMapType() {
      if (mapType === 'ROADMAP') {
        map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
        mapType = 'HYBRID';
      } else {
        map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);
        mapType = 'ROADMAP';
      }
    }

    window.onload = initMap;
  </script>
</body>
</html>
