<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì¸ëª…êµ¬ì¡°í•¨ ì§€ë„ (ë„¤ì´ë²„ + Firebase)</title>    
  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=y6akfogygp"></script>    
  <style>    
    html, body, #map { width: 100%; height: 100%; margin: 0; padding: 0; }    
    #locationButton, #mapTypeSelector, #sosButton {    
      position: absolute;    
      z-index: 100;    
      padding: 6px 10px;    
      border: 1px solid #ccc;    
      border-radius: 4px;    
      font-size: 14px;    
      cursor: pointer;    
    }    
    #locationButton, #mapTypeSelector {    
      background: rgba(255, 255, 255, 0.9);    
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);    
    }    
    #sosButton {    
      top: 10px;    
      right: 10px;    
      background: #ffdddd;    
      color: red;    
      font-weight: bold;    
      border-radius: 8px;    
      padding: 8px 12px;    
      font-size: 14px;    
    }    
    #locationButton:hover, #mapTypeSelector:hover { background: #f0f0f0; }    
    #sosButton:hover { background: #ffe0e0; }    
    #locationButton { top: 10px; left: 10px; }    
    #mapTypeSelector { top: 50px; left: 10px; }    
  </style>    
</head>    
<body>    
  <div id="map"></div>    
  <button id="locationButton">ë‚´ ìœ„ì¹˜ë¡œ ì´ë™</button>    
  <button id="mapTypeSelector">ìœ„ì„±ë·°</button>    
  <button id="sosButton">ğŸš¨ êµ¬ì¡° ìš”ì²­</button>    

  <script type="module">    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";    
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";  

    const firebaseConfig = {    
      apiKey: "AIzaSyDAWuBw94gzYiPrUTOY41zque2WvgCnRj4",    
      authDomain: "kcghelp-cf3e4.firebaseapp.com",    
      databaseURL: "https://kcghelp-cf3e4-default-rtdb.firebaseio.com",    
      projectId: "kcghelp-cf3e4",    
      storageBucket: "kcghelp-cf3e4.appspot.com",    
      messagingSenderId: "374111271871",    
      appId: "1:374111271871:web:d1cf45fdc2a93930c77f0a",    
      measurementId: "G-DGDBZ38LW4"    
    };    

    const app = initializeApp(firebaseConfig);    
    const database = getDatabase(app);    

    let myLat = 37.75, myLng = 128.9;
    let map = new naver.maps.Map('map', {
      center: new naver.maps.LatLng(myLat, myLng),
      zoom: 12,
      mapTypeControl: false
    });

    let myMarker = null; 
    let firstCentered = false;

    const markers = []; 
    const infoWindows = [];

    function sendSosRequest(lat, lng) {
      const requestsRef = ref(database, 'emergency/requests'); 
      return push(requestsRef, { lat, lng, timestamp: Date.now() }); 
    }

    function loadMarkers() {
      fetch("lifesavers.json")
        .then(res => res.json())
        .then(data => {
          data.forEach(item => {
            if (item.lat && item.lng) {
              const marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(item.lat, item.lng),
                icon: {
                  url: "/help.png",
                  size: new naver.maps.Size(40, 45),
                  scaledSize: new naver.maps.Size(40, 45),
                  anchor: new naver.maps.Point(20, 45),
                },
                map,
                zIndex: 1000
              });

              const url = `https://map.naver.com/v5/directions/-/141.6,37.6,,PLACE_POI/${item.lng},${item.lat},ì¸ëª…êµ¬ì¡°í•¨,PLACE_POI`;
              const content = `<div style="padding:6px; font-size:13px;">
                ì¸ëª…êµ¬ì¡°í•¨<br>
                <button onclick="window.location.href='${url}'" style="margin-top:5px; background:none; border:none; color:blue; text-decoration:underline; cursor:pointer;">
                  ê¸¸ì°¾ê¸°
                </button>
              </div>`;

              const infoWindow = new naver.maps.InfoWindow({    
                content,    
                zIndex: 1100    
              });    

              marker.addListener('click', () => {    
                infoWindows.forEach(iw => iw.close());    
                infoWindow.open(map, marker);    
              });    

              markers.push(marker);    
              infoWindows.push(infoWindow);    
            }
          });
          updateMarkers();
        });
    }

    function updateMarkers() {
      const bounds = map.getBounds();
      markers.forEach(marker => {
        const visible = bounds.hasLatLng(marker.getPosition());
        marker.setMap(visible ? map : null);
      });
      // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ëŠ” í•­ìƒ í‘œì‹œ
      if (myMarker) myMarker.setMap(map);
    }

    naver.maps.Event.addListener(map, 'idle', updateMarkers);

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        myLat = pos.coords.latitude;
        myLng = pos.coords.longitude;
        const location = new naver.maps.LatLng(myLat, myLng);

        const HOME_PATH = '.'; // ì´ ë¶€ë¶„ ì¶”ê°€í•´ì„œ ê²½ë¡œëª… í™•ì‹¤íˆ ì§€ì •

  if (!myMarker) {
    myMarker = new naver.maps.Marker({
      position: location,
      map: map,
      icon: {
        url: HOME_PATH + "/hi.png",
        size: new naver.maps.Size(40, 40),
        origin: new naver.maps.Point(0, 0),
        anchor: new naver.maps.Point(20, 40),
      },
      zIndex: 1200
    });
        } else {
          myMarker.setPosition(location);
        }

        if (!firstCentered) {
          map.setCenter(location);
          map.setZoom(17);
          firstCentered = true;
        }
      });
    }

    loadMarkers();

    document.getElementById('locationButton').onclick = () => {
      if (myLat && myLng)
        map.setCenter(new naver.maps.LatLng(myLat, myLng));
    };

    document.getElementById('mapTypeSelector').onclick = function () {
      const isSatellite = map.getMapTypeId() === naver.maps.MapTypeId.SATELLITE;
      map.setMapTypeId(isSatellite ? naver.maps.MapTypeId.BASIC : naver.maps.MapTypeId.SATELLITE);
      this.textContent = isSatellite ? "ìœ„ì„±ë·°" : "ì¼ë°˜ ì§€ë„";
    };

    document.getElementById('sosButton').onclick = () => {
      if (!myLat || !myLng) return alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      const agree = confirm("[ìœ„ì¹˜ì •ë³´ ì œê³µ ë™ì˜]\nêµ¬ì¡° ìš”ì²­ ì‹œ í˜„ì¬ ìœ„ì¹˜ê°€ ì „ì†¡ë˜ë©°, ìš”ì²­ ì •ë³´ëŠ” 24ì‹œê°„ ë’¤ ìë™ ì‚­ì œë©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
      if (!agree) return;

      sendSosRequest(myLat, myLng)
        .then(() => alert("êµ¬ì¡° ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤."))
        .catch(() => alert("ì „ì†¡ ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
    };

  </script>
</body>
</html>
